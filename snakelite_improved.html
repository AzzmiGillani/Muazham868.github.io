<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snake Plus+ ‚Äî Improved</title>
<style>
  :root{
    --panel-bg: rgba(255,255,255,0.92);
    --btn: #2ea44f; --btn-hover:#23823a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,Roboto,Arial,sans-serif;background:linear-gradient(135deg,#e6f7ff,#fff0f6);display:flex;align-items:center;justify-content:center;}
  #container{width:440px;max-width:96vw;position:relative;padding:14px;}
  canvas{display:block;width:400px;height:400px;border:4px solid #333;background:#d6f2d6;image-rendering:pixelated;}
  #controlsTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  #scoreboard{background:var(--panel-bg);padding:8px 12px;border-radius:10px;font-weight:700;display:flex;gap:10px;align-items:center;}
  #levelboard{background:var(--panel-bg);padding:6px 10px;border-radius:8px;font-weight:700;color:#222;margin-left:10px;}
  .btn{background:var(--btn);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn:hover{background:var(--btn-hover)}
  #overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--panel-bg);padding:18px 22px;border-radius:12px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:50;display:none}
  #popup{position:fixed;left:50%;top:14%;transform:translateX(-50%);z-index:60;pointer-events:none}
  .popupBubble{padding:10px 16px;border-radius:10px;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,0.15);opacity:0;animation:popAnim 1.8s forwards}
  @keyframes popAnim{0%{opacity:0;transform:translateY(-12px) scale(.95)}10%{opacity:1;transform:translateY(0) scale(1)}80%{opacity:1}100%{opacity:0;transform:translateY(-12px) scale(.95)}}
  /* joystick */
  #joystick{position:absolute;bottom:8px;right:8px;display:none;flex-direction:column;gap:10px;z-index:40}
  .joy-btn{width:56px;height:56px;border-radius:50%;background:var(--btn);color:#fff;border:none;font-size:20px;box-shadow:0 6px 14px rgba(0,0,0,0.16)}
  .joy-btn:active{transform:scale(.98)}
  @media(max-width:420px){#joystick{display:flex} .joy-btn{width:48px;height:48px;font-size:18px}}
  /* footer link */
  #footerLink{position:fixed;left:10px;bottom:10px;background:rgba(255,255,255,0.9);padding:6px 10px;border-radius:8px;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,0.12);z-index:70}
  #footerLink a{color:#222;text-decoration:none} #footerLink a:hover{color:var(--btn)}
</style>
</head>
<body>
  <div id="container" role="main">
    <div id="controlsTop">
      <div style="display:flex;align-items:center;gap:8px">
        <div id="scoreboard" aria-live="polite">Score: 0 | High: 0</div>
        <div id="levelboard">Level: 1</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="pauseBtn" class="btn" style="display:none">Pause</button>
        <button id="restartBtn" class="btn" style="display:none">Restart</button>
      </div>
    </div>

    <canvas id="gameCanvas" width="400" height="400" role="img" aria-label="Snake game canvas"></canvas>

    <div id="overlay" role="dialog" aria-modal="true">
      <div style="font-weight:900;font-size:20px" id="overlayTitle">üêç Snake Plus+</div>
      <div style="margin-top:8px;color:#333;font-weight:700">Reach 30 to win ‚Äî Arrow keys (WASD) or joystick</div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
        <button id="newGameBtn" class="btn">New Game (reset high)</button>
        <button id="continueBtn" class="btn">Continue</button>
      </div>
    </div>

    <div id="popup" aria-hidden="true"></div>

    <div id="joystick" aria-hidden="true">
      <button class="joy-btn" id="joy-up">‚ñ≤</button>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="joy-btn" id="joy-left">‚óÄ</button>
        <button class="joy-btn" id="joy-right">‚ñ∂</button>
      </div>
      <button class="joy-btn" id="joy-down">‚ñº</button>
    </div>
  </div>

  <div id="footerLink"><a href="https://chatgpt.com/share/68c8e34a-18b0-8001-aca5-bffd1253cff1" target="_blank" rel="noopener noreferrer">How this game was made</a></div>

<script>
/* --- Config --- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const overlayTitle = document.getElementById('overlayTitle');
const scoreboard = document.getElementById('scoreboard');
const levelboard = document.getElementById('levelboard');
const popupHolder = document.getElementById('popup');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const newGameBtn = document.getElementById('newGameBtn');
const continueBtn = document.getElementById('continueBtn');
const joystick = document.getElementById('joystick');

const BOX = 20, COLS = 20, ROWS = 20;
const WIN_SCORE = 30;
const LEVEL_UP_EVERY = 5;
const START_SPEED = 160;
const SPEED_PER_LEVEL = 8;
const MIN_SPEED = 80;

/* color arrays by level (index 1-based visually) */
const borderColors = ['#333','#1e90ff','#ff8c00','#8a2be2','#ff1493','#228b22','#b22222','#ffd700'];
const snakeColors = [
  {head:'#356634', body:'#4caf50'},
  {head:'#003366', body:'#1e90ff'},
  {head:'#cc5500', body:'#ff8c00'},
  {head:'#4b0082', body:'#8a2be2'},
  {head:'#b03060', body:'#ff1493'},
  {head:'#006400', body:'#228b22'},
  {head:'#8b0000', body:'#b22222'},
  {head:'#b8860b', body:'#ffd700'}
];

/* state */
let snake = [];
let direction = null;
let lastDirection = null;
let apple = null;
let decorations = [];
let score = 0;
let level = 1;
let highScore = parseInt(localStorage.getItem('snakeHighScore')) || 0;
let speed = START_SPEED;
let gameInterval = null;
let isGameOver = false;
let isWin = false;

/* sounds (online) */
const eatSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2574/2574-preview.mp3');
const gameOverSound = new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3');
const winSound = new Audio('https://assets.mixkit.co/active_storage/sfx/3764/3764-preview.mp3');
const rewardSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2039/2039-preview.mp3');

/* --- utilities --- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function randCell(){return {x:Math.floor(Math.random()*COLS)*BOX,y:Math.floor(Math.random()*ROWS)*BOX};}
function eq(a,b){return a.x===b.x && a.y===b.y;}
function clearLoop(){ if(gameInterval){ clearInterval(gameInterval); gameInterval = null; } }

/* --- decorations --- */
function initDecorations(){
  decorations = [];
  for(let i=0;i<14;i++){
    decorations.push(randCell());
    decorations[i].type = Math.random()<0.5 ? 'bush' : 'tree';
  }
}
function drawDecorations(){
  decorations.forEach(d=>{
    if(d.type==='bush'){
      drawRounded(d.x+3,d.y+6,BOX-6,BOX-8,6,'#0b6b0b','#064806');
    } else {
      ctx.fillStyle='#8b5a2b'; ctx.fillRect(d.x+BOX/3,d.y+BOX/2,BOX/3,BOX/2);
      ctx.fillStyle='#2e8b57'; ctx.beginPath(); ctx.ellipse(d.x+BOX/2,d.y+BOX/2,BOX/2.1,BOX/2.1,0,0,Math.PI*2); ctx.fill();
    }
  });
}

/* rounded rect helper */
function drawRounded(x,y,w,h,r,fill,stroke){
  ctx.beginPath();
  const rx = Math.min(r,w/2);
  ctx.moveTo(x+rx,y);
  ctx.arcTo(x+w,y,x+w,y+h,rx);
  ctx.arcTo(x,y+h,x,y+h-rx,rx);
  ctx.arcTo(x,y,x+rx,y,rx);
  ctx.closePath();
  if(fill){ ctx.fillStyle=fill; ctx.fill(); }
  if(stroke){ ctx.strokeStyle=stroke; ctx.stroke(); }
}

/* --- apple --- */
function placeApple(){
  let ok=false;
  while(!ok){
    apple = randCell();
    ok = !snake.some(s=>eq(s,apple));
  }
}
function drawApple(){
  const cx = apple.x + BOX/2, cy = apple.y + BOX/2, r = BOX/2.6;
  const g = ctx.createRadialGradient(cx - r*0.3, cy - r*0.45, r*0.2, cx, cy, r);
  g.addColorStop(0,'#ff6b6b'); g.addColorStop(0.6,'#e64040'); g.addColorStop(1,'#a31717');
  ctx.fillStyle = g; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.45)'; ctx.beginPath(); ctx.ellipse(cx - r/3, cy - r/2.2, r/3, r/6, -0.6, 0, Math.PI*2); ctx.fill();
  // small leaf
  ctx.fillStyle='#1f8a2e'; ctx.beginPath(); ctx.ellipse(cx + r*0.35, cy - r*0.8, r*0.45, r*0.25, -0.8, 0, Math.PI*2); ctx.fill();
}

/* --- snake drawing with level-based colors --- */
function getLevelIndex(){ return clamp((level-1) % snakeColors.length,0,snakeColors.length-1); }
function drawSnake(){
  const idx = getLevelIndex();
  const colors = snakeColors[idx];
  for(let i=0;i<snake.length;i++){
    const s = snake[i];
    const grad = ctx.createLinearGradient(s.x, s.y, s.x+BOX, s.y+BOX);
    const fill = (i===0) ? colors.head : colors.body;
    const lighter = (i===0) ? shadeColor(colors.head, 12) : shadeColor(colors.body, 12);
    grad.addColorStop(0, fill); grad.addColorStop(1, lighter);
    drawRounded(s.x+1, s.y+1, BOX-2, BOX-2, 6, grad, '#173d17');
  }
  // simple eye on head
  if(snake.length){
    const head = snake[0];
    const eyePos = getEyeOffset(lastDirection || direction || 'RIGHT');
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(head.x + eyePos.x - 1, head.y + eyePos.y - 1, 2.6, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(head.x + eyePos.x - 0.8, head.y + eyePos.y - 0.6, 1.2, 0, Math.PI*2); ctx.fill();
  }
}
function getEyeOffset(dir){
  switch(dir){
    case 'LEFT': return {x:6,y:10};
    case 'RIGHT': return {x:BOX-6,y:10};
    case 'UP': return {x:10,y:6};
    default: return {x:10,y:BOX-6};
  }
}
/* small color shade helper */
function shadeColor(hex, percent){
  // hex to RGB, lighten by percent
  const f=parseInt(hex.slice(1),16);
  const t = percent<0?0:255;
  const p = Math.abs(percent)/100;
  const R = Math.round((t - (f>>16)) * p) + (f>>16);
  const G = Math.round((t - ((f>>8)&0x00FF)) * p) + ((f>>8)&0x00FF);
  const B = Math.round((t - (f&0x0000FF)) * p) + (f&0x0000FF);
  return `rgb(${R},${G},${B})`;
}

/* --- grid and border --- */
function drawGrid(){
  ctx.save();
  ctx.strokeStyle = '#bfe6b7'; ctx.lineWidth=1;
  for(let x=0;x<=canvas.width;x+=BOX){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<=canvas.height;y+=BOX){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.restore();
}
function drawBorder(){
  const bcol = borderColors[(level-1) % borderColors.length] || '#333';
  ctx.lineWidth = 5; ctx.strokeStyle = bcol; ctx.strokeRect(0,0,canvas.width,canvas.height);
}

/* --- scoreboard / UI functions --- */
function updateScoreboard(){
  scoreboard.textContent = `Score: ${score} | High: ${highScore}`;
  levelboard.textContent = `Level: ${level}`;
}
function popup(msg,type='info'){
  // single popup element
  const div = document.createElement('div');
  div.className = 'popupBubble';
  div.textContent = msg;
  // color by type
  if(type === 'level'){ div.style.background = '#4CAF50'; div.style.color = '#fff'; }
  else if(type === 'gameover'){ div.style.background = '#f44336'; div.style.color = '#fff'; }
  else if(type === 'highscore'){ div.style.background = '#FFD700'; div.style.color = '#000'; }
  else { div.style.background = '#fff3b0'; div.style.color = '#5a3b00'; }
  popupHolder.innerHTML = ''; popupHolder.appendChild(div);
  // element removes itself via CSS animation; clear after 2s
  setTimeout(()=>{ if(popupHolder.contains(div)) popupHolder.removeChild(div); }, 1900);
}

/* --- reset/start/loop --- */
function resetGameState(resetHigh=false){
  if(resetHigh){ localStorage.setItem('snakeHighScore','0'); highScore = 0; }
  snake = [{x:10*BOX,y:10*BOX},{x:9*BOX,y:10*BOX},{x:8*BOX,y:10*BOX}];
  direction = null; lastDirection = null; score = 0; level = 1; speed = START_SPEED;
  isGameOver = false; isWin = false;
  placeApple(); initDecorations(); updateScoreboard();
  overlay.style.display = 'none';
  pauseBtn.style.display = 'inline-block'; restartBtn.style.display = 'inline-block';
  joystick.style.display = (window.innerWidth <= 420) ? 'flex' : 'none';
  draw(); // initial draw
  startLoop();
}

function startLoop(){
  clearLoop();
  gameInterval = setInterval(gameLoop, speed);
}

function stopLoop(){
  clearLoop();
}

/* --- collisions, movement, game logic --- */
function gameLoop(){
  if(!direction) return; // wait until first input
  const head = {...snake[0]};
  if(direction === 'LEFT') head.x -= BOX;
  if(direction === 'RIGHT') head.x += BOX;
  if(direction === 'UP') head.y -= BOX;
  if(direction === 'DOWN') head.y += BOX;

  // wall collision
  if(head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height){
    return handleGameOver();
  }
  // self collision
  if(snake.some(s => s.x === head.x && s.y === head.y)) return handleGameOver();

  snake.unshift(head);

  // apple eaten
  if(eq(head, apple)){
    score++;
    try{ eatSound.currentTime = 0; eatSound.play().catch(()=>{}); }catch(e){}
    // level calculation
    const oldLevel = level;
    level = Math.floor(score / LEVEL_UP_EVERY) + 1;
    // gentle speed change per level:
    speed = Math.max(MIN_SPEED, START_SPEED - (level - 1) * SPEED_PER_LEVEL);
    // restart loop with new speed
    startLoop();

    // place new apple
    placeApple();
    // level-up popup (only when level increased)
    if(level > oldLevel){
      popup(`LEVEL ${level} REACHED!`, 'level');
      try{ rewardSound.currentTime = 0; rewardSound.play().catch(()=>{}); }catch(e){}
    }

    // if reached win
    if(score >= WIN_SCORE) return handleWin();
  } else {
    snake.pop();
  }

  lastDirection = direction;
  updateScoreboard();
  draw();
}

/* handle end conditions */
function handleGameOver(){
  isGameOver = true; stopLoop();
  try{ gameOverSound.currentTime = 0; gameOverSound.play().catch(()=>{}); }catch(e){}
  // update highscore and show at the end (popup)
  const wasNewHigh = score > highScore;
  if(wasNewHigh){
    highScore = score;
    localStorage.setItem('snakeHighScore', highScore);
  }
  overlay.style.display = 'block';
  overlayTitle.textContent = 'üíÄ Game Over';
  overlay.querySelector('div')?.remove?.(); // safe
  // set overlay message with final stats
  overlay.innerHTML = `<div style="font-weight:900;font-size:20px">üíÄ Game Over</div>
    <div style="margin-top:8px">Score: ${score} | Level: ${level} | High: ${highScore}</div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
      <button id="overlayNew" class="btn">Try Again</button>
      <button id="overlayMenu" class="btn">Main Menu</button>
    </div>`;
  if(wasNewHigh) popup('NEW HIGH SCORE!', 'highscore');
  // wire overlay buttons freshly
  document.getElementById('overlayNew').addEventListener('click', ()=>{ resetGameState(false); });
  document.getElementById('overlayMenu').addEventListener('click', ()=>{ location.reload(); });
}

function handleWin(){
  isWin = true; stopLoop();
  try{ winSound.currentTime = 0; winSound.play().catch(()=>{}); }catch(e){}
  const wasNewHigh = score > highScore;
  if(wasNewHigh){ highScore = score; localStorage.setItem('snakeHighScore',highScore); }
  overlay.style.display = 'block';
  overlayTitle.textContent = 'üéâ You Beat the Game!';
  overlay.innerHTML = `<div style="font-weight:900;font-size:20px">üéâ You Beat the Game!</div>
    <div style="margin-top:8px">Score: ${score} | Level: ${level} | High: ${highScore}</div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
      <button id="overlayPlay" class="btn">Play Again</button>
      <button id="overlayMenu2" class="btn">Main Menu</button>
    </div>`;
  if(wasNewHigh) popup('NEW HIGH SCORE!', 'highscore');
  document.getElementById('overlayPlay').addEventListener('click', ()=>{ resetGameState(false); });
  document.getElementById('overlayMenu2').addEventListener('click', ()=>{ location.reload(); });
}

/* draw all */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawDecorations();
  drawGrid();
  drawSnake();
  drawApple();
  drawBorder();
}

/* controls */
document.addEventListener('keydown', e=>{
  if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') changeDir('LEFT');
  if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') changeDir('RIGHT');
  if(e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') changeDir('UP');
  if(e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') changeDir('DOWN');
  if(e.key === 'Enter' && overlay.style.display === 'block'){ overlay.style.display = 'none'; resetGameState(false); }
});
function changeDir(dir){
  if(isGameOver || isWin) return;
  const opposite = {LEFT:'RIGHT', RIGHT:'LEFT', UP:'DOWN', DOWN:'UP'};
  if(opposite[dir] === lastDirection) return;
  direction = dir;
}

/* joystick */
['joy-up','joy-down','joy-left','joy-right'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener('click', ()=>{ if(id==='joy-up') changeDir('UP'); if(id==='joy-down') changeDir('DOWN'); if(id==='joy-left') changeDir('LEFT'); if(id==='joy-right') changeDir('RIGHT'); });
    el.addEventListener('touchstart', e=>{ e.preventDefault(); el.click(); });
  }
});

/* pause/restart/new/continue handlers */
pauseBtn.addEventListener('click', ()=>{
  if(gameInterval){ stopLoop(); pauseBtn.textContent = 'Resume'; } else { startLoop(); pauseBtn.textContent = 'Pause'; }
});
restartBtn.addEventListener('click', ()=>{ resetGameState(false); });
newGameBtn.addEventListener('click', ()=>{ resetGameState(true); });
continueBtn.addEventListener('click', ()=>{ overlay.style.display='none'; resetGameState(false); });

/* save/load omitted to keep code robust for testing (can re-add later) */

/* initial UI state */
window.onload = ()=>{
  overlay.style.display = 'block';
  // set overlay default content again (in case altered)
  overlay.innerHTML = `<div style="font-weight:900;font-size:20px" id="overlayTitle">üêç Snake Plus+</div>
    <div style="margin-top:8px;color:#333;font-weight:700">Reach 30 to win ‚Äî Arrow keys (WASD) or joystick</div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
      <button id="newGameBtnInner" class="btn">New Game (reset high)</button>
      <button id="continueBtnInner" class="btn">Continue</button>
    </div>`;
  // re-bind (inner)
  document.getElementById('newGameBtnInner').addEventListener('click', ()=>{ resetGameState(true); });
  document.getElementById('continueBtnInner').addEventListener('click', ()=>{ overlay.style.display='none'; resetGameState(false); });
  // hide joystick until playing on mobile
  joystick.style.display = (window.innerWidth <= 420) ? 'flex' : 'none';
  updateScoreboard();
};

/* responsive joystick visibility */
window.addEventListener('resize', ()=>{ joystick.style.display = (window.innerWidth <= 420 && overlay.style.display==='none') ? 'flex' : 'none'; });

/* small helpers */
function drawGrid(){
  ctx.save();
  ctx.strokeStyle = '#bfe6b7'; ctx.lineWidth = 1;
  for(let x=0;x<=canvas.width;x+=BOX){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<=canvas.height;y+=BOX){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.restore();
}

/* initial decorations draw helper used above (already included) */

/* Expose minimal test helpers for dev if needed (not required) */

</script>
</body>
</html>
